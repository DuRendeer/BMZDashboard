class MusicPlayer {
    constructor() {
        this.audioPlayer = document.getElementById('audio-player');
        this.currentMessage = document.getElementById('current-message');
        this.currentSong = document.getElementById('current-song');
        this.status = document.getElementById('status');
        this.lastTimestamp = null;
        
        this.init();
    }
    
    init() {
        this.setStatus('üü¢ Online');
        this.setupActivateButton();
        this.setupClearLogsButton();
        this.enableAutoplay();
        this.startPolling();
        this.loadLogs();
    }
    
    setupActivateButton() {
        // Fun√ß√£o removida - controle agora √© via radio buttons
    }
    
    enableAutoplay() {
        // Preparar contexto de √°udio
        document.addEventListener('click', () => {
            this.audioPlayer.muted = false;
        }, { once: true });
        
        // Auto-intera√ß√£o invis√≠vel para habilitar autoplay
        setTimeout(() => {
            this.audioPlayer.play().catch(() => {
                console.log('Preparing audio context...');
            });
            this.audioPlayer.pause();
        }, 100);
    }
    
    setStatus(statusText) {
        this.status.textContent = statusText;
        const statusDot = document.getElementById('status-dot');
        
        if (statusText.includes('Online')) {
            statusDot.classList.add('online');
        } else {
            statusDot.classList.remove('online');
        }
    }
    
    startPolling() {
        setInterval(() => {
            this.checkForNewCommands();
        }, 2000);
    }
    
    async checkForNewCommands() {
        try {
            const response = await fetch('api/status.php');
            const data = await response.json();
            
            if (data.success && data.data) {
                const commandData = data.data;
                
                if (commandData.timestamp && commandData.timestamp !== this.lastTimestamp) {
                    this.playMusic(commandData);
                    this.lastTimestamp = commandData.timestamp;
                } else if (!commandData.timestamp) {
                    this.showMessage(commandData.message);
                }
            }
            
            this.setStatus('üü¢ Online');
            
        } catch (error) {
            console.error('Error checking for commands:', error);
            this.setStatus('üî¥ Offline - Erro de conex√£o');
        }
    }
    
    // Fun√ß√£o original playMusic movida para cima
    
    forceAutoplay(commandData) {
        if (!this.autoplayEnabled) {
            console.log('‚ö†Ô∏è Autoplay n√£o ativado pelo usu√°rio');
            this.showPlayButton(commandData);
            return;
        }
        
        // Tentar reprodu√ß√£o direta se autoplay foi ativado
        setTimeout(() => {
            this.audioPlayer.play().then(() => {
                console.log('üéµ Autoplay funcionou! M√∫sica iniciada:', commandData.music_name);
                this.showMessage(`üéµ Reproduzindo: ${commandData.music_name}`, true);
            }).catch((error) => {
                console.warn('Autoplay falhou mesmo ativado:', error.message);
                this.showPlayButton(commandData);
            });
        }, 300);
    }

    showPlayButton(commandData) {
        const playBtn = document.getElementById('manual-play-btn');
        const playBtnText = document.getElementById('play-btn-text');
        
        playBtnText.textContent = `‚ñ∂Ô∏è Tocar: ${commandData.music_name}`;
        playBtn.style.display = 'block';
        playBtn.classList.add('pulse');
        
        playBtn.onclick = () => {
            this.audioPlayer.play().then(() => {
                console.log('Music started playing after user interaction');
                this.showMessage(`üéµ Reproduzindo: ${commandData.music_name}`, true);
                playBtn.style.display = 'none';
            }).catch((error) => {
                console.error('Error playing music:', error);
                this.showMessage(`‚ùå Erro: ${error.message}`);
            });
        };
    }
    
    tryFallbackUrl(fallbackUrl, musicName) {
        console.log('Trying fallback URL:', fallbackUrl);
        this.audioPlayer.src = fallbackUrl;
        this.audioPlayer.load();
        
        this.audioPlayer.play().then(() => {
            console.log('Fallback URL worked');
            this.showMessage(`‚ñ∂Ô∏è Reproduzindo: ${musicName}`, true);
        }).catch((error) => {
            console.error('Fallback also failed:', error);
            this.showMessage(`‚ùå Arquivo n√£o encontrado: ${musicName}`);
        });
    }
    
    showMessage(message, isActive = false) {
        this.currentMessage.textContent = message;
        this.currentMessage.classList.remove('active');
        
        if (isActive) {
            this.currentMessage.classList.add('active');
        }
    }

    setupClearLogsButton() {
        const clearBtn = document.getElementById('clear-logs-btn');
        const toggleBtn = document.getElementById('toggle-history-btn');
        const historyPanel = document.getElementById('history-panel');
        const cardBody = document.querySelector('.card-body');

        // Bot√£o limpar logs
        clearBtn.onclick = async () => {
            try {
                await fetch('api/logs.php', { method: 'DELETE' });
                this.loadLogs();
            } catch (error) {
                console.error('Error clearing logs:', error);
            }
        };

        // Bot√£o toggle para minimizar/expandir
        let isMinimized = false;
        toggleBtn.onclick = () => {
            isMinimized = !isMinimized;
            if (isMinimized) {
                cardBody.style.display = 'none';
                toggleBtn.textContent = '+';
            } else {
                cardBody.style.display = 'block';
                toggleBtn.textContent = '‚àí';
            }
        };

        // Setup controles de autoplay
        const autoplayOn = document.getElementById('autoplay-on');
        const autoplayOff = document.getElementById('autoplay-off');
        
        // Verificar estado salvo
        const isActivated = localStorage.getItem('autoplay-activated') === 'true';
        if (isActivated) {
            autoplayOn.checked = true;
            this.autoplayEnabled = true;
        }

        // Event listeners para mudan√ßa
        autoplayOn.onchange = () => {
            if (autoplayOn.checked) {
                this.activateAutoplay();
            }
        };

        autoplayOff.onchange = () => {
            if (autoplayOff.checked) {
                this.autoplayEnabled = false;
                localStorage.setItem('autoplay-activated', 'false');
            }
        };
    }

    activateAutoplay() {
        const testAudio = new Audio();
        testAudio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAAC';
        testAudio.volume = 0.01;
        testAudio.play().then(() => {
            localStorage.setItem('autoplay-activated', 'true');
            this.autoplayEnabled = true;
            console.log('üîä Autoplay ativado!');
        }).catch(() => {
            document.getElementById('autoplay-off').checked = true;
            console.log('Erro ao ativar autoplay');
        });
    }

    async loadLogs() {
        try {
            const response = await fetch('api/logs.php');
            const data = await response.json();
            
            if (data.success) {
                this.displayLogs(data.data);
            }
        } catch (error) {
            console.error('Error loading logs:', error);
        }
    }

    displayLogs(logs) {
        const container = document.getElementById('logs-container');
        
        if (!logs || logs.length === 0) {
            container.innerHTML = '<div class="log-empty">Nenhum registro</div>';
            return;
        }

        container.innerHTML = logs.map(log => `
            <div class="log-item">
                <div class="log-header">
                    <span class="log-closer">${log.closer}</span>
                    <span class="log-time">${log.date}</span>
                </div>
                <div class="log-music">üéµ ${log.music_name}</div>
                <div class="log-message">"${log.message}"</div>
            </div>
        `).join('');
    }

    playMusic(commandData) {
        this.showMessage(commandData.message, true);
        
        this.currentSong.textContent = `üéµ ${commandData.music_name}`;
        this.currentSong.classList.add('fade-in');
        
        if (commandData.music_url) {
            console.log('üéµ Tentando carregar:', commandData.music_url);
            this.audioPlayer.src = commandData.music_url;
            this.audioPlayer.load();
            
            // For√ßar reprodu√ß√£o autom√°tica
            this.forceAutoplay(commandData);
        }
        
        // Recarregar logs ap√≥s nova m√∫sica
        setTimeout(() => {
            this.loadLogs();
        }, 1000);
        
        setTimeout(() => {
            this.currentSong.classList.remove('fade-in');
        }, 500);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    // Simular intera√ß√£o autom√°tica ao carregar p√°gina
    setTimeout(() => {
        // Clique invis√≠vel autom√°tico
        const autoClick = new MouseEvent('click', {
            view: window,
            bubbles: true,
            cancelable: true,
            clientX: 1,
            clientY: 1
        });
        document.body.dispatchEvent(autoClick);
        console.log('ü§ñ Auto-intera√ß√£o simulada');
    }, 500);
    
    // For√ßar contexto de √°udio ativo
    const silentAudio = new Audio();
    silentAudio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LHfSgELYPL9OWnWw0DUK7r8q1hEAlMq9/ns1YSB0Ok2+6vcCAVJ2GG7Mtp';
    silentAudio.volume = 0;
    silentAudio.play().catch(() => {});
    
    new MusicPlayer();
});